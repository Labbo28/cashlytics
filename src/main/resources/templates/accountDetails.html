<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <!-- Font import from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@1,700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>tba</title>
</head>

<body>
    <!-- HEADER / NAVIGATION -->
    <nav class="container mt-lg back-nav">
        <a th:href="@{/{u}/dashboard(u=${username})}">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </nav>

    <div class="container">
        <!-- ACCOUNT HEADER CARD -->
        <div class="account-header" th:if="${account}">
            <div class="account-info">
                <div>
                    <h2 th:text="${account.accountType}">Account Type</h2>
                </div>
                <div class="balance" th:text="'€' + ${#numbers.formatDecimal(account.balance, 1, 2)}">
                    €0.00
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS CONTAINER -->
        <div class="transactions-container">
            <div class="transactions-header">
                <h3>
                    <i class="fas fa-list"></i> Recent Transactions
                </h3>
                <button onclick="toggleTransactionForm()" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i> Add Transaction
                </button>
            </div>

            <!-- NO TRANSACTIONS MESSAGE -->
            <div th:if="${#lists.isEmpty(transactions)}" class="no-transactions">
                <i class="fas fa-receipt"></i>
                <h4>No transactions yet</h4>
                <p>Start by adding your first transaction to track your account activity.</p>
                <button onclick="toggleTransactionForm()" class="btn btn-accent btn-sm"
                    style="margin-top: var(--spacing-md);">
                    <i class="fas fa-plus"></i> Add Your First Transaction
                </button>
            </div>

            <!-- TRANSACTIONS LIST -->
            <div th:if="${!#lists.isEmpty(transactions)}">
                <a th:each="transaction : ${transactions}"
                    th:href="@{/{u}/transaction/{id}(u=${username},id=${transaction.id})}" class="transaction-item"
                    th:classappend="${transaction.transactionType.toString() == 'INCOME'} ? ' transaction-positive' : ' transaction-negative'">

                    <div class="transaction-details">
                        <div class="transaction-icon"
                            th:classappend="${transaction.transactionType.toString() == 'INCOME'} ? ' positive' : ' negative'">
                            <i
                                th:class="${transaction.transactionType.toString() == 'INCOME'} ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                        </div>

                        <div class="transaction-info">
                            <div class="transaction-type" th:text="${transaction.transactionType}">
                                Transaction Type
                            </div>
                            <div class="transaction-date"
                                th:text="${#temporals.format(transaction.date, 'dd/MM/yyyy HH:mm')}">
                                01/01/2024 12:00
                            </div>
                        </div>
                    </div>

                    <div class="transaction-amount"
                        th:classappend="${transaction.transactionType.toString() == 'INCOME'} ? ' positive' : ' negative'"
                        th:text="${transaction.transactionType.toString() == 'INCOME' 
                                     ? '+€' + #numbers.formatDecimal(transaction.amount, 1, 2) 
                                     : '-€' + #numbers.formatDecimal(transaction.amount, 1, 2)}">
                        €0.00
                    </div>
                </a>
            </div>
        </div>

        <!-- ERROR / SUCCESS ALERTS -->
        <div th:if="${errorMessage}" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}"></span>
        </div>
        <div th:if="${successMessage}" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}"></span>
        </div>
    </div>

    <!-- ADD TRANSACTION MODAL FORM (Initially Hidden) -->
    <div id="addTransactionForm" class="form-overlay" style="display: none;">
        <div class="form-modal">
            <h3>Add New Transaction</h3>
            <form th:action="@{/{u}/account/{id}/add-transaction(u=${username},id=${account.id})}"
                th:object="${transactionDTO}" method="post">
                <div class="form-group">
                    <label for="transactionType">Transaction Type</label>
                    <select th:field="*{transactionType}" id="transactionType" required>
                        <option value="">Select Transaction Type</option>
                        <option th:each="type : ${transactionTypes}" th:value="${type}" th:text="${type}">
                            Transaction Type
                        </option>
                    </select>
                    <span class="error" th:if="${#fields.hasErrors('transactionType')}" th:errors="*{transactionType}">
                    </span>
                </div>

                <div class="form-group">
                    <label for="amount">Amount (€)</label>
                    <input type="number" th:field="*{amount}" id="amount" step="0.01" placeholder="0.00" required />
                    <span class="error" th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}">
                    </span>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea th:field="*{description}" id="description" placeholder="Enter transaction description..."
                        required></textarea>
                    <span class="error" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">
                    </span>
                </div>

                <div class="form-group">
                    <label for="categoryInput">Category</label>
                    <input type="text" id="categoryInput" th:field="*{categoryName}" list="categoriesList"
                        placeholder="Type or select a category…" required />
                    <datalist id="categoriesList">
                        <option th:each="cat : ${categories}" th:value="${cat.name}" />
                    </datalist>
                    <input type="hidden" th:field="*{categoryId}" />
                    <span class="error" th:if="${#fields.hasErrors('categoryName')}" th:errors="*{categoryName}">
                    </span>
                </div>

                <div class="form-group">
                    <label for="merchantInput">Merchant</label>
                    <input type="text" id="merchantInput" th:field="*{merchantName}" list="merchantsList"
                        placeholder="Type or select a merchant…" required />
                    <datalist id="merchantsList">
                        <option th:each="m : ${merchants}" th:value="${m.name}" />
                    </datalist>
                    <input type="hidden" th:field="*{merchantId}" />
                    <span class="error" th:if="${#fields.hasErrors('merchantName')}" th:errors="*{merchantName}">
                    </span>
                </div>

                <div class="form-buttons">
                    <button type="button" onclick="toggleTransactionForm()" class="btn btn-secondary btn-sm">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ENHANCED SCRIPT -->
    <script>
        function toggleTransactionForm() {
            const overlay = document.getElementById('addTransactionForm');
            const form = overlay.querySelector('form');

            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
                form.reset();
                document.body.style.overflow = 'auto';
            } else {
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // Focus on first input
                setTimeout(() => {
                    const firstInput = form.querySelector('select, input');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        // Close modal when clicking outside
        document.getElementById('addTransactionForm').addEventListener('click', function (e) {
            if (e.target === this) {
                toggleTransactionForm();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('addTransactionForm');
                if (overlay.style.display === 'flex') {
                    toggleTransactionForm();
                }
            }
        });

        // Enhanced form validation feedback
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('blur', function () {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.style.borderColor = 'var(--warning)';
                } else {
                    this.style.borderColor = 'var(--neutral-light)';
                }
            });

            input.addEventListener('input', function () {
                if (this.style.borderColor === 'var(--warning)' && this.value.trim()) {
                    this.style.borderColor = 'var(--primary)';
                }
            });
        });
    </script>
</body>

</html>